<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Christmas - New Photos</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { 
            margin: 0; overflow: hidden; 
            background: radial-gradient(circle at center, #140824 0%, #000000 100%);
            font-family: 'Dancing Script', cursive; 
        }
        #canvas-container { width: 100%; height: 100vh; display: block; }
        
        /* UI LAYER */
        #ui-layer {
            position: absolute; bottom: 40px; width: 100%;
            text-align: center; pointer-events: none; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .guide-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            padding: 12px 30px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff; font-size: 18px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            text-shadow: 0 0 8px rgba(255,215,0,0.6);
            display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;
        }
        .guide-box span { margin: 0 10px; }

        /* BUTTONS */
        button#btnStart {
            pointer-events: auto; cursor: pointer;
            background: linear-gradient(135deg, #ff0055, #ff5500);
            color: #FFF; border: none;
            padding: 15px 50px; border-radius: 50px; 
            font-family: 'Pacifico', cursive; font-size: 24px; letter-spacing: 2px;
            box-shadow: 0 0 40px rgba(255, 0, 85, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button#btnStart:hover { transform: scale(1.05); box-shadow: 0 0 60px rgba(255, 0, 85, 0.8); }

        #btnCamToggle {
            position: absolute; top: 20px; left: 20px;
            width: 50px; height: 50px;
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3); border-radius: 50%;
            color: #FFF; font-size: 20px; cursor: pointer; z-index: 200;
            display: none; transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #btnCamToggle:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        #btnCamToggle.off { background: #ff0055; box-shadow: 0 0 20px #ff0055; }

        /* CAMERA PREVIEW */
        #camera-wrapper {
            position: absolute; top: 20px; right: 20px;
            width: 140px; height: 105px; z-index: 50; pointer-events: none;
        }
        #camera-preview {
            width: 100%; height: 100%;
            border: 2px solid rgba(255, 255, 255, 0.3); 
            transform: scaleX(-1); opacity: 0.8; border-radius: 12px;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
        }
        #cam-placeholder {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            color: rgba(255,255,255,0.5); font-size: 30px; display: none;
        }

        /* LYRICS */
        #lyrics-container {
            position: absolute; top: 135px; right: 20px; 
            width: 550px; text-align: right; pointer-events: none; z-index: 90;
        }
        .lyric-line {
            font-family: 'Pacifico', cursive; font-size: 26px; line-height: 1.5;
            display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 20px; 
        }
        .word {
            display: inline-block; color: rgba(255, 255, 255, 0.25); 
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: all 0.05s linear; transform-origin: center bottom;
        }
        .word.active {
            color: #FFD700; text-shadow: 0 0 15px #FF0055, 0 0 30px #FF4500; 
            opacity: 1; transform: scale(1.25) translateY(-2px); font-weight: bold;
        }
        
        #copyright { position: absolute; bottom: 15px; right: 20px; color: rgba(255,255,255,0.3); font-size: 14px; z-index: 100; pointer-events: none; }
        
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #FFD700; font-size: 32px; pointer-events: none; display: none; 
            font-family: 'Pacifico', cursive; text-shadow: 0 0 20px rgba(255, 100, 100, 0.8);
            z-index: 200; text-align: center; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%,100% { opacity: 0.8; transform: translate(-50%,-50%) scale(1); } 50% { opacity: 1; transform: translate(-50%,-50%) scale(1.1); } }
    </style>
</head>
<body>
    
    <button id="btnCamToggle" title="B·∫≠t/T·∫Øt Camera"><i class="fas fa-video"></i></button>

    <div id="lyrics-container"></div>

    <div id="ui-layer">
        <div class="guide-box" id="guideText">
             <span>‚úä <b>N·∫Øm tay:</b> C√¢y Th√¥ng</span>
             <span>üñê <b>X√≤e tay:</b> Bung T·ªèa üí•</span>
             <span>‚úåÔ∏è <b>Hi (2 ng√≥n):</b> Xem ·∫¢nh</span>
             <span>ü§ü <b>I Love U:</b> Tr√°i Tim</span>
        </div>
        <button id="btnStart"> Start Magic ‚ú® </button>
    </div>

    <div id="copyright">¬© designed by S1mple</div>
    <div id="loading">ƒêang kh·ªüi ƒë·ªông Camera... ‚ù§Ô∏è</div>

    <div id="canvas-container"></div>
    
    <div id="camera-wrapper">
        <canvas id="camera-preview"></canvas>
        <div id="cam-placeholder"><i class="fas fa-video-slash"></i></div>
    </div>
    <video class="input_video" style="display:none"></video>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        const OFFSET = 0.5; 
        const CONFIG = {
            goldCount: 2000, redCount: 500, snowCount: 1500, heartCount: 300,    
            explodeRadius: 250, // B√°n k√≠nh n·ªï l·ªõn
            photoOrbitRadius: 35, treeHeight: 75, treeBaseRadius: 38
        };
        const MUSIC_URL = "./imissyou.mp3"; 
        
        // --- LYRICS DATA ---
        const lyricsData = [
            { start: 0, end: 10, text: "Wait for music... üéµ" },
            { start: 10.8, end: 13.5, text: "Does it mean it's over now?" },
            { start: 13.6, end: 16.0, text: "You never open up..." },
            { start: 16.5, end: 19.0, text: "Would you tell me we're okay?" },
            { start: 19.2, end: 22.0, text: "I understand I'm trying now" },
            { start: 22.2, end: 25.0, text: "I'm momentary time without..." },
            { start: 25.5, end: 28.5, text: "Is it really over now?" },
            { start: 29.5, end: 31.8, text: "Sick to my stomach" },
            { start: 32.0, end: 33.8, text: "Saying I'm sorry" }, 
            { start: 34.0, end: 37.0, text: "Maybe we can write it out..." },
            { start: 37.5, end: 41.0, text: "Everything will quiet down" },
            { start: 41.5, end: 43.8, text: "'Cause I won't give up" },
            { start: 44.0, end: 45.8, text: "A fork in the road" },
            { start: 46.0, end: 47.8, text: "Under my skin..." },
            { start: 48.0, end: 50.5, text: "You're the scent in my clothes" },
            { start: 51.0, end: 54.0, text: "And I'm waiting..." },
            { start: 55.0, end: 58.0, text: "Every night praying that..." },
            { start: 58.5, end: 61.5, text: "I call and maybe you'll pick up" },
            { start: 62.0, end: 65.5, text: "I know that it's been so long" },
            { start: 66.0, end: 68.0, text: "Stay up all night..." },
            { start: 68.5, end: 72.0, text: "If you would just try this" },
            { start: 72.5, end: 76.0, text: "Oh I really wanted you to know..." },
            { start: 76.2, end: 81.0, text: "I Miss You... ‚ù§Ô∏è" },
            { start: 81.5, end: 85.0, text: "I'm hoping maybe you want me" },
            { start: 85.5, end: 89.0, text: "I know we were going so good" },
            { start: 89.5, end: 93.0, text: "Stay up all night..." },
            { start: 93.5, end: 96.0, text: "If you would just try this" },
            { start: 96.5, end: 100.0, text: "Oh I really wanted you to know..." },
            { start: 100.5, end: 105.0, text: "I Miss You ‚ù§Ô∏è" }
        ];

        // --- UPDATED PHOTO URLs ---
        const photoFiles = [
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRXlXoiEhEErtSZKhv5GsVkESszOJHGH2FiW38ZaIhldw&s=10',
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSPt9szWqjNk4GNU-sctOYMbpecYUkcbgi5-qNfM6XKvQ&s=10',
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS5gqT7YWIKxtFxT36TzWDliEf4NAV1SxtBbAXuGrHHhQ&s=10',
            'https://labelle.vn/wp-content/uploads/2025/05/hinh-nen-anh-hoa-dep-tu-nhien-13.jpg',
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT41cGotN2jSWKyo5ad46HNGv9TDITJcRA1vT_5xCYS5Q&s=10'
        ];
        
        const loader = new THREE.TextureLoader();
        // Enable cross-origin loading for external images
        loader.setCrossOrigin('anonymous');
        const photoTextures = [];

        // --- HELPER FUNCTIONS ---
        function createRealisticGlow(colorCore, colorOuter) {
            const canvas = document.createElement('canvas'); canvas.width = 128; canvas.height = 128; 
            const ctx = canvas.getContext('2d');
            const grd = ctx.createRadialGradient(64, 64, 2, 64, 64, 60);
            grd.addColorStop(0, '#FFFFFF'); grd.addColorStop(0.2, colorCore); grd.addColorStop(0.6, colorOuter); grd.addColorStop(1, 'rgba(0,0,0,0)'); 
            ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(64, 64, 64, 0, Math.PI*2); ctx.fill();
            return new THREE.CanvasTexture(canvas);
        }
        function createHeartTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = "#FF0044"; 
            ctx.shadowColor = "#FF2266"; ctx.shadowBlur = 15; ctx.translate(64, 64); ctx.scale(3, 3);
            ctx.beginPath(); const d = "M0 -10 C -10 -25 -25 -10 -10 5 L 0 15 L 10 5 C 25 -10 10 -25 0 -10 Z"; ctx.fill(new Path2D(d));
            return new THREE.CanvasTexture(canvas);
        }

        const STAR_LENS_FLARE = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAMAAAD04JH5AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+/Ps0H6YgAAABTSURBVHja7M9BCQAwDMCw96/8M3QOEkjgrY7tK4BCEIAQBCAMQAhCAEIAQhiAEIAQBCAMQAhCAEIAQhiAEIAgB44AAwD9uA783Y82OAAAAABJRU5ErkJggg==";
        const textures = { gold: createRealisticGlow('#FFFFA0', '#FFD700'), red: createRealisticGlow('#FF80A0', '#FF0055'), snow: createRealisticGlow('#FFFFFF', '#A0E0FF'), heart: createHeartTexture() };

        let scene, camera, renderer, bgMusic = null;
        let groupGold, groupRed, groupSnow, groupHearts;
        let photoMeshes = [], titleMesh, starMesh, loveMesh, starHaloMesh; 
        
        // --- CONTROL VARIABLES ---
        let state = 'TREE'; 
        let selectedIndex = 0; 
        let time = 0; lastTime = 0; currentLineIndex = -1;
        let handRotationTarget = 0; 

        // --- GESTURE SMOOTHING VARIABLES ---
        let pendingState = 'TREE';
        let stateHoldCounter = 0;
        const STATE_HOLD_THRESHOLD = 5; 
        
        let handsObj = null, cameraObj = null, isCameraOn = false;

        function init3D() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x140824, 0.002);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000); camera.position.z = 110;
            scene.add(new THREE.AmbientLight(0x404040, 2)); 
            const pl = new THREE.PointLight(0xFFD700, 1.5, 200); pl.position.set(0, 100, 50); scene.add(pl);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
            renderer.toneMapping = THREE.ACESFilmicToneMapping; renderer.toneMappingExposure = 1.2;
            container.appendChild(renderer.domElement);

            createBackgroundSnow(); createFallingHearts();
            groupGold = createMagicParticles('gold', CONFIG.goldCount, 3.0);
            groupRed = createMagicParticles('red', CONFIG.redCount, 4.5);
            createPhotos();
            document.fonts.ready.then(() => createDecorations());
            window.addEventListener('resize', () => { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });
            animate();
        }

        // --- PARTICLE SYSTEMS ---
        function createBackgroundSnow() {
            const geo = new THREE.BufferGeometry(); const pos = [], vel = [];
            for(let i=0; i<CONFIG.snowCount; i++) { pos.push((Math.random()-0.5)*400,(Math.random()-0.5)*300,(Math.random()-0.5)*300-50); vel.push((Math.random()-0.5)*0.2,-0.2-Math.random()*0.3,0); }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3)); geo.userData = { velocities: vel };
            groupSnow = new THREE.Points(geo, new THREE.PointsMaterial({ color: 0xFFFFFF, size: 2.5, map: textures.snow, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending, depthWrite: false }));
            scene.add(groupSnow);
        }
        function createFallingHearts() {
            const geo = new THREE.BufferGeometry(); const pos = [], spd = [];
            for(let i=0; i<CONFIG.heartCount; i++) { pos.push((Math.random()-0.5)*500,120+Math.random()*250,(Math.random()-0.5)*400); spd.push(15+Math.random()*25); }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3)); geo.userData = { speeds: spd };
            groupHearts = new THREE.Points(geo, new THREE.PointsMaterial({ size: 6, map: textures.heart, transparent: true, opacity: 0.85, depthWrite: false, blending: THREE.NormalBlending }));
            scene.add(groupHearts);
        }
        function createMagicParticles(type, count, size) {
            const pos=[], tree=[], exp=[], hrt=[], sizes=[], phases=[], clrs=new Float32Array(count*3);
            const baseC = new THREE.Color(type==='gold'?0xFFD700:0xFF0055);
            for(let i=0; i<count; i++) {
                // Tree Shape
                const h = Math.random()*CONFIG.treeHeight, y=h-CONFIG.treeHeight/2, r=(1-h/CONFIG.treeHeight)*CONFIG.treeBaseRadius*(type==='gold'?Math.sqrt(Math.random()):(0.9+Math.random()*0.1));
                const theta=Math.random()*Math.PI*2; tree.push(r*Math.cos(theta),y,r*Math.sin(theta));
                
                // Explode Shape (Sphere)
                const phi=Math.acos(2*Math.random()-1), lam=2*Math.PI*Math.random(), rad=CONFIG.explodeRadius*Math.cbrt(Math.random());
                exp.push(rad*Math.sin(phi)*Math.cos(lam),rad*Math.sin(phi)*Math.sin(lam),rad*Math.cos(phi));
                
                // Heart Shape
                const t=Math.random()*Math.PI*2, s=1.8*Math.sqrt(Math.random());
                hrt.push(16*Math.pow(Math.sin(t),3)*s, (13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t))*s+5, (Math.random()-0.5)*15);

                pos.push((Math.random()-0.5)*100,(Math.random()-0.5)*100,(Math.random()-0.5)*100); sizes.push(size*(0.6+Math.random()*0.8)); phases.push(Math.random()*Math.PI*2);
                const v=0.1*(Math.random()-0.5); clrs[i*3]=Math.min(1,baseC.r+v); clrs[i*3+1]=Math.min(1,baseC.g+v); clrs[i*3+2]=Math.min(1,baseC.b+v);
            }
            const geo = new THREE.BufferGeometry(); geo.setAttribute('position',new THREE.Float32BufferAttribute(pos,3)); geo.setAttribute('size',new THREE.Float32BufferAttribute(sizes,1)); geo.setAttribute('color',new THREE.BufferAttribute(clrs,3));
            geo.userData = { tree:tree, explode:exp, heart:hrt, phases:phases, baseColor:baseC, baseSize:size };
            const pts = new THREE.Points(geo, new THREE.PointsMaterial({ size:size, map:textures[type], transparent:true, opacity:1, vertexColors:true, blending:THREE.AdditiveBlending, depthWrite:false, sizeAttenuation:true }));
            scene.add(pts); return pts;
        }

        function createDecorations() {
            const createTxt = (txt, clr, sz) => {
                const cvs = document.createElement('canvas'); cvs.width=1024; cvs.height=256; const ctx=cvs.getContext('2d');
                ctx.font = `bold ${sz}px 'Pacifico'`; ctx.textAlign='center'; ctx.textBaseline='middle';
                ctx.shadowColor=clr; ctx.shadowBlur=40; ctx.fillStyle='#FFF'; ctx.fillText(txt,512,128);
                ctx.shadowBlur=20; ctx.fillStyle=clr; ctx.fillText(txt,512,128); return new THREE.CanvasTexture(cvs);
            };
            titleMesh = new THREE.Mesh(new THREE.PlaneGeometry(60,15), new THREE.MeshBasicMaterial({ map:createTxt("Merry Christmas","#FFD700",90), transparent:true, blending:THREE.AdditiveBlending }));
            titleMesh.position.set(0,55,0); scene.add(titleMesh);
            
            loveMesh = new THREE.Mesh(new THREE.PlaneGeometry(90,25), new THREE.MeshBasicMaterial({ map:createTxt("Miss You So Much","#FF1493",90), transparent:true, blending:THREE.AdditiveBlending }));
            loveMesh.position.set(0,-30,30); loveMesh.visible=false; scene.add(loveMesh);
            
            const shape = new THREE.Shape(); const oR=5, iR=2.5;
            for(let i=0;i<10;i++) { const r=i%2?iR:oR, a=i/10*Math.PI*2; i?shape.lineTo(Math.cos(a)*r,Math.sin(a)*r):shape.moveTo(Math.cos(a)*r,Math.sin(a)*r); } shape.closePath();
            starMesh = new THREE.Mesh(new THREE.ExtrudeGeometry(shape,{depth:1.5,bevelEnabled:true,bevelThickness:0.5}), new THREE.MeshStandardMaterial({color:0xFFD700,emissive:0xFFFF00,emissiveIntensity:0.5,roughness:0.3,metalness:0.8}));
            starMesh.position.set(0,CONFIG.treeHeight/2+5,0); starMesh.scale.set(0.8,0.8,0.8); scene.add(starMesh);
            starHaloMesh = new THREE.Sprite(new THREE.SpriteMaterial({map:loader.load(STAR_LENS_FLARE), color:0xFFBB00, blending:THREE.AdditiveBlending, transparent:true, opacity:0.5}));
            starHaloMesh.scale.set(30,30,1); starHaloMesh.position.copy(starMesh.position); scene.add(starHaloMesh);
        }

        function createPhotos() {
            photoFiles.forEach((u,i) => {
                photoTextures[i] = loader.load(u, undefined, undefined, (err) => {
                    console.error("L·ªói t·∫£i ·∫£nh (c√≥ th·ªÉ do CORS):", u);
                });
            });
            for(let i=0; i<5; i++) {
                const m = new THREE.Mesh(new THREE.PlaneGeometry(10,10), new THREE.MeshBasicMaterial({ map:photoTextures[i], side:THREE.DoubleSide, transparent:true }));
                const f = new THREE.Mesh(new THREE.PlaneGeometry(11,11), new THREE.MeshBasicMaterial({ color:0xFFD700, transparent:true, opacity:0.8 }));
                f.position.z=-0.1; m.add(f); m.visible=false; m.scale.set(0,0,0); scene.add(m); photoMeshes.push(m);
            }
        }

        function updateLyrics() {
            if (!bgMusic || bgMusic.paused) return;
            const t = bgMusic.currentTime - OFFSET; 
            let idx = -1; for(let i=0; i<lyricsData.length; i++) if(t>=lyricsData[i].start && t<=lyricsData[i].end) { idx=i; break; }
            if(idx!==currentLineIndex) {
                currentLineIndex=idx; 
                document.getElementById('lyrics-container').innerHTML = idx!==-1 ? `<div class="lyric-line">${lyricsData[idx].text.split(" ").map(w=>`<span class="word">${w}</span>`).join("")}</div>` : "";
            }
            if(idx!==-1) {
                const spans = document.querySelectorAll('.word');
                if(spans.length) {
                    const prog = (t-lyricsData[idx].start)/(lyricsData[idx].end-lyricsData[idx].start);
                    spans.forEach((s,i) => { if(i<=Math.floor(prog*spans.length) && !s.classList.contains('active')) s.classList.add('active'); });
                }
            }
        }

        function animate(now=0) {
            requestAnimationFrame(animate);
            const dt = Math.min((now-lastTime)/1000, 0.033); lastTime=now; time+=dt;
            if(groupSnow) { 
                const pos=groupSnow.geometry.attributes.position.array, vel=groupSnow.geometry.userData.velocities;
                for(let i=0; i<pos.length; i+=3) { pos[i]+=vel[i/3*3]*10*dt+Math.sin(time+pos[i+1]*0.05)*0.1; pos[i+1]+=vel[i/3*3+1]*30*dt; if(pos[i+1]<-100){pos[i+1]=150;pos[i]=(Math.random()-0.5)*400;} }
                groupSnow.geometry.attributes.position.needsUpdate=true;
            }
            if(groupHearts) {
                const pos=groupHearts.geometry.attributes.position.array, spd=groupHearts.geometry.userData.speeds;
                for(let i=0; i<pos.length; i+=3) { pos[i+1]-=spd[i/3]*dt; pos[i]+=Math.sin(time*2+i/3)*25*dt; if(pos[i+1]<-100){pos[i+1]=250;pos[i]=(Math.random()-0.5)*500;} }
                groupHearts.geometry.attributes.position.needsUpdate=true;
            }
            updateParticleGroup(groupGold, 'gold', state, dt);
            updateParticleGroup(groupRed, 'red', state, dt);
            updateUI(dt); updateLyrics();
            renderer.render(scene, camera);
        }

        // --- CORE UPDATE LOGIC ---
        function updateParticleGroup(grp, type, target, dt) {
            if(!grp) return;
            const pos=grp.geometry.attributes.position.array, sz=grp.geometry.attributes.size.array, clr=grp.geometry.attributes.color.array, ud=grp.geometry.userData;
            const tgtArr = ud[target.toLowerCase()] || ud.explode;
            
            const speed = (target === 'EXPLODE') ? 4.0 : 3.0;
            for(let i=0; i<pos.length; i++) pos[i]+=(tgtArr[i]-pos[i])*speed*dt;
            
            if (target === 'EXPLODE') {
                const targetRot = handRotationTarget;
                grp.rotation.y += (targetRot - grp.rotation.y) * 2.5 * dt;
            } else if (target === 'TREE' || target === 'HEART' || target === 'PHOTO') {
                grp.rotation.y += 0.5 * dt;
            } else {
                grp.rotation.y = 0;
            }

            const cnt=pos.length/3;
            for(let i=0; i<cnt; i++) {
                if(target==='HEART') { 
                    sz[i]=ud.baseSize*(1.5+0.5*Math.sin(time*3+ud.phases[i])); 
                    if(type==='gold') { clr[i*3]=1.0; clr[i*3+1]=0.2; clr[i*3+2]=0.5; } 
                    else { clr[i*3]=1.0; clr[i*3+1]=0.0; clr[i*3+2]=0.2; } 
                }
                else if(target==='TREE') { 
                    const f=0.7+0.3*Math.sin(time*5+ud.phases[i]); 
                    clr[i*3]=ud.baseColor.r*f; clr[i*3+1]=ud.baseColor.g*f; clr[i*3+2]=ud.baseColor.b*f; sz[i]=ud.baseSize; 
                }
                else { 
                    clr[i*3]=ud.baseColor.r; clr[i*3+1]=ud.baseColor.g; clr[i*3+2]=ud.baseColor.b; sz[i]=ud.baseSize; 
                }
            }
            grp.geometry.attributes.position.needsUpdate=true; grp.geometry.attributes.size.needsUpdate=true; grp.geometry.attributes.color.needsUpdate=true;
        }

        function updateUI(dt) {
            const isT=state==='TREE', isH=state==='HEART', isP=state==='PHOTO';
            if(titleMesh) { titleMesh.visible=isT; titleMesh.position.y=55+Math.sin(time)*2; }
            if(loveMesh) { loveMesh.visible=isH; loveMesh.scale.setScalar(1+Math.sin(time*3)*0.1); }
            if(starMesh) { starMesh.visible=isT; starMesh.rotation.y+=dt*1.5; starMesh.rotation.z=Math.sin(time)*0.1; }
            if(starHaloMesh) { starHaloMesh.visible=isT; const p=1+0.05*Math.sin(time*3); starHaloMesh.scale.set(30*p,30*p,1); starHaloMesh.rotation.z-=dt*0.2; }
            
            photoMeshes.forEach((m,i) => {
                m.visible = !isT && !isH; 
                if(m.visible) {
                    if(isP && i===selectedIndex) { m.position.lerp(new THREE.Vector3(0,0,70),0.1); m.scale.lerp(new THREE.Vector3(3.5,3.5,3.5),0.1); m.lookAt(camera.position); }
                    else {
                        const a = i*(Math.PI*2)/5 + time*0.5;
                        m.position.lerp(new THREE.Vector3(Math.sin(a)*35,Math.sin(a*3)*5,Math.cos(a)*35),0.05); m.lookAt(camera.position);
                        m.scale.lerp(new THREE.Vector3(isP?0:1,isP?0:1,isP?0:1),0.1);
                    }
                }
            });
        }

        // --- CAMERA & HAND LOGIC ---
        document.getElementById('btnStart').addEventListener('click', async () => {
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            try { if(!bgMusic) { bgMusic = new Audio(MUSIC_URL); bgMusic.loop=true; bgMusic.volume=1.0; } await bgMusic.play(); } catch(e){}
            init3D();
            await setupCamera(); startCamera(); 
            document.getElementById('btnCamToggle').style.display = 'block';
        });

        document.getElementById('btnCamToggle').addEventListener('click', () => { isCameraOn ? stopCamera() : startCamera(); });

        async function setupCamera() {
            const video = document.querySelector('.input_video');
            handsObj = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
            handsObj.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
            handsObj.onResults(onHandsResults);
            cameraObj = new Camera(video, {
                onFrame: async () => { if(isCameraOn) await handsObj.send({image: video}); },
                width: 320, height: 240
            });
        }

        function startCamera() {
            const camPreview = document.getElementById('camera-preview');
            const placeholder = document.getElementById('cam-placeholder');
            const btn = document.getElementById('btnCamToggle');
            document.getElementById('loading').style.display = 'block';
            cameraObj.start().then(() => {
                isCameraOn = true;
                document.getElementById('loading').style.display = 'none';
                camPreview.style.display = 'block'; placeholder.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-video"></i>'; btn.classList.remove('off');
            });
        }

        function stopCamera() {
            isCameraOn = false;
            const video = document.querySelector('.input_video');
            const camPreview = document.getElementById('camera-preview');
            const placeholder = document.getElementById('cam-placeholder');
            const btn = document.getElementById('btnCamToggle');
            const ctx = camPreview.getContext('2d');
            if(video.srcObject) { video.srcObject.getTracks().forEach(track => track.stop()); video.srcObject = null; }
            ctx.clearRect(0, 0, camPreview.width, camPreview.height);
            camPreview.style.display = 'none'; placeholder.style.display = 'flex';
            btn.innerHTML = '<i class="fas fa-video-slash"></i>'; btn.classList.add('off');
            state = 'TREE'; 
        }

        function onHandsResults(results) {
            const canvas = document.getElementById('camera-preview');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if(isCameraOn && results.image) {
                ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
                if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    processHandGestures(results.multiHandLandmarks[0]);
                } else {
                    stateHoldCounter = 0; 
                }
            }
        }

        // --- GESTURE PROCESSING (GOLDEN SET) ---
        function processHandGestures(hand) {
            let detectedState = pendingState;

            // Helper: Check if finger is OPEN (tip above pip)
            const isFingerOpen = (idx) => hand[idx].y < hand[idx-2].y;

            const index   = isFingerOpen(8);
            const middle  = isFingerOpen(12);
            const ring    = isFingerOpen(16);
            const pinky   = isFingerOpen(20);

            // Count OPEN fingers (ignoring thumb for simpler logic)
            let fingersUp = 0;
            if (index) fingersUp++;
            if (middle) fingersUp++;
            if (ring) fingersUp++;
            if (pinky) fingersUp++;

            // --- RECOGNITION LOGIC ---

            // 1. HEART (ü§ü I Love You: Index + Pinky Open, Middle + Ring Closed)
            if (index && pinky && !middle && !ring) {
                detectedState = 'HEART';
            }
            // 2. PHOTO (‚úåÔ∏è Peace: Index + Middle Open, Ring + Pinky Closed)
            else if (index && middle && !ring && !pinky) {
                detectedState = 'PHOTO';
                // Rotation Control by Index Finger X position
                selectedIndex = Math.floor((1 - hand[8].x) * 5) % 5;
                if(selectedIndex < 0) selectedIndex = 0;
            }
            // 3. EXPLODE (üñê Open Hand: >= 3 fingers up)
            else if (fingersUp >= 3) {
                detectedState = 'EXPLODE';
                handRotationTarget = (0.5 - hand[9].x) * 5; 
            }
            // 4. TREE (‚úä Fist: 0 or 1 finger up)
            else if (fingersUp <= 1) { 
                detectedState = 'TREE';
            }

            // --- DEBOUNCE LOGIC (ANTI-SHAKE) ---
            if (detectedState === pendingState) {
                stateHoldCounter++;
                if (stateHoldCounter > STATE_HOLD_THRESHOLD) { // Must hold for 5 frames
                    state = detectedState;
                }
            } else {
                pendingState = detectedState;
                stateHoldCounter = 0;
            }
        }
    </script>
</body>

</html>
